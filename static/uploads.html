<!DOCTYPE html>
<html>
<head>
  <title>Video Upload</title>
</head>
<body>

  <h2>Upload Video</h2>

  <form id="uploadForm">
    <input type="text" id="title" placeholder="Title" required />
    <br><br>

    <textarea id="description" placeholder="Description"></textarea>
    <br><br>

    <input type="file" id="video" accept="video/*" required />
    <br><br>

    <button type="submit">Upload</button>
  </form>

  <p id="status"></p>

  <script src="https://unpkg.com/tus-js-client/dist/tus.js"></script>

</body>
<script>
    const form = document.getElementById("uploadForm")
    const status = document.getElementById("status")

    form.addEventListener("submit", async (e) => {
    e.preventDefault()

    const file = document.getElementById("video").files[0]
    const title = document.getElementById("title").value
    const description = document.getElementById("description").value

    if (!file) {
        alert("Select a video")
        return
    }

    status.innerText = "Requesting upload slot..."

    // 1Ô∏è‚É£ Ask your backend to create a TUS upload
    const res = await fetch("https://tivess-be-89v3.onrender.com/api/v1/admin/admin-uploadContent", {
        method: "POST",
        headers: {
        "Content-Type": "application/json"
        },
        body: JSON.stringify({
        title,
        description,
        filename: file.name,
        filesize: file.size,
        filetype: file.type
        })
    })

    const data = await res.json()
    console.log(data);

    const uploadUrl = data.uploadURL   // from Cloudflare Stream or tus-server
    const uploadId = data.videoUID        // your DB record id

    // 2Ô∏è‚É£ Upload file directly using TUS
    const upload = new tus.Upload(file, {
        endpoint: uploadUrl,
        retryDelays: [0, 3000, 5000, 10000],
        metadata: {
        filename: file.name,
        filetype: file.type,
        title,
        description
        },

        onError: function (error) {
            status.innerText = "Upload failed: " + error;
        },

        onProgress: function (bytesUploaded, bytesTotal) {
        const percent = ((bytesUploaded / bytesTotal) * 100).toFixed(1)
        status.innerText = `Uploading: ${percent}%`
        },

        onSuccess: async function () {
            status.innerText = "Finalizing...(done)"

            // 3Ô∏è‚É£ Tell backend upload finished
            const statusRes = await fetch("https://tivess-be-89v3.onrender.com/api/v1/admin/admin-uploadContent", {
                method: "POST",
                headers: {
                "Content-Type": "application/json"
                },
                body: JSON.stringify({
                uploadId,
                tusUrl: upload.url
                })
            })

            const statusData = await statusRes.json();
            if (statusData.data?.state === "ready") status.innerText = "Upload complete üéâ";

            status.innerText = "Upload complete üéâ";
        }
    });

    upload.start();
});
</script>
</html>
